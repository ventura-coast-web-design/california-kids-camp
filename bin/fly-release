#!/bin/bash -e
# Run during fly deploy release_command. Creates DBs and runs all migrations
# so the app entrypoint only needs db:prepare and can start the server quickly.

echo "Running release: migrations and extra DBs..."

# Create solid_cache, solid_queue, solid_cable databases before migrations
if [ -n "$DATABASE_URL" ]; then
  DB_NAME=$(echo "$DATABASE_URL" | sed -n 's|.*/\([^/?]*\).*|\1|p')
  BASE_URL=$(echo "$DATABASE_URL" | sed 's|/[^/]*$|/postgres|')
  if [ -n "$DB_NAME" ] && [ -n "$BASE_URL" ]; then
    for suffix in cache queue cable; do
      psql "$BASE_URL" -tc "SELECT 1 FROM pg_database WHERE datname = '${DB_NAME}_${suffix}'" 2>/dev/null | grep -q 1 || \
        psql "$BASE_URL" -c "CREATE DATABASE ${DB_NAME}_${suffix};" || true
    done
  fi
fi

bundle exec rails db:migrate
bundle exec rails db:migrate:cache 2>/dev/null || true
bundle exec rails db:migrate:queue 2>/dev/null || true
bundle exec rails db:migrate:cable 2>/dev/null || true

echo "Release complete."
