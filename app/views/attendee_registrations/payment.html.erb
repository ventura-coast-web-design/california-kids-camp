<div class="content-section">
  <div class="section-header">
    <h2 class="section-title">Complete Payment</h2>
  </div>
  
  <div class="section-content">
    <div class="form-container">
      <!-- Payment Summary -->
      <div class="border-b border-gray-200 pb-6 mb-6">
        <h3 class="text-xl font-semibold mb-4 text-gray-800">Registration Summary</h3>
        <div class="bg-gray-50 rounded-lg p-4">
          <div class="flex justify-between items-center mb-2">
            <span class="text-gray-700">Number of children:</span>
            <span class="font-semibold"><%= @child_count %></span>
          </div>
          <% if @attendee_registration.pricing_type == 'early_bird' %>
            <div class="mb-2">
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                Early Bird Pricing
              </span>
            </div>
          <% end %>
          <div class="flex justify-between items-center text-lg font-semibold pt-2 border-t border-gray-200">
            <span>Total Amount:</span>
            <span class="text-blue-600">$<%= sprintf('%.2f', @amount) %></span>
          </div>
        </div>
      </div>

      <!-- Payment Form -->
      <div class="border-b border-gray-200 pb-6">
        <h3 class="text-xl font-semibold mb-4 text-gray-800">Payment Information</h3>
        
        <!-- Payment Type Selection -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-3">Payment Option</label>
          <div class="space-y-3">
            <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-blue-500 transition-colors payment-option">
              <input type="radio" name="payment_type" value="deposit" class="mr-3 h-4 w-4 text-blue-600 focus:ring-blue-500" checked>
              <div class="flex-1">
                <div class="font-semibold text-gray-900">Pay Deposit</div>
                <div class="text-sm text-gray-600">$50.00 per attendee deposit (balance due later)</div>
              </div>
              <div class="text-lg font-bold text-blue-600">$<%= sprintf('%.2f', @deposit_amount) %></div>
            </label>
            <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-blue-500 transition-colors payment-option">
              <input type="radio" name="payment_type" value="full" class="mr-3 h-4 w-4 text-blue-600 focus:ring-blue-500">
              <div class="flex-1">
                <div class="font-semibold text-gray-900">Pay in Full</div>
                <div class="text-sm text-gray-600">Complete payment now</div>
              </div>
              <div class="text-lg font-bold text-blue-600">$<%= sprintf('%.2f', @amount) %></div>
            </label>
          </div>
        </div>
        
        <form id="payment-form">
          <div id="card-element" class="mb-4">
            <!-- Stripe Elements will create form elements here -->
          </div>
          
          <!-- Display form errors -->
          <div id="card-errors" role="alert" class="text-red-600 mb-4"></div>
          
          <div class="form-actions">
            <button type="submit" id="submit-button" class="btn btn-primary w-full">
              <span id="button-text">Pay $<span id="payment-amount"><%= sprintf('%.2f', @deposit_amount) %></span></span>
              <span id="spinner" style="display: none;">Processing...</span>
            </button>
          </div>
        </form>
      </div>

      <div class="mt-6 text-center">
        <%= link_to "Back to Registration", "#", onclick: "history.back(); return false;", class: "text-blue-600 hover:text-blue-800" %>
      </div>
    </div>
  </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
  // Initialize Stripe
  const stripe = Stripe('<%= @stripe_publishable_key %>');
  
  // Get registration ID (temporary UUID string for new registrations, or database ID for existing)
  const registrationId = '<%= @temp_registration_id || params[:id] %>';
  const fullAmount = <%= @amount %>;
  const depositAmount = <%= @deposit_amount %>;
  
  // Create payment intent and set up Stripe Elements
  let elements;
  let cardElement;
  let currentPaymentType = 'deposit';
  let currentClientSecret = null;
  
  // Update payment amount when payment type changes
  function updatePaymentAmount() {
    const paymentTypeRadios = document.querySelectorAll('input[name="payment_type"]');
    const paymentAmountSpan = document.getElementById('payment-amount');
    
    paymentTypeRadios.forEach(radio => {
      // Update selected state styling
      const label = radio.closest('label.payment-option');
      if (radio.checked) {
        label.classList.add('selected');
      }
      
      radio.addEventListener('change', async function() {
        currentPaymentType = this.value;
        
        // Update styling
        document.querySelectorAll('label.payment-option').forEach(l => l.classList.remove('selected'));
        this.closest('label.payment-option').classList.add('selected');
        
        if (this.value === 'deposit') {
          paymentAmountSpan.textContent = depositAmount.toFixed(2);
        } else {
          paymentAmountSpan.textContent = fullAmount.toFixed(2);
        }
        
        // Recreate payment intent when payment type changes
        await createPaymentIntent(this.value);
      });
    });
  }
  
  // Create payment intent
  async function createPaymentIntent(paymentType) {
    try {
      const response = await fetch(`/attendee_registrations/${registrationId}/create_payment_intent`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({
          payment_type: paymentType
        })
      });
      
      if (!response.ok) {
        throw new Error('Failed to create payment intent');
      }
      
      const data = await response.json();
      
      if (data.error) {
        document.getElementById('card-errors').textContent = data.error;
        return null;
      }
      
      if (!data.clientSecret) {
        document.getElementById('card-errors').textContent = 'Failed to initialize payment. Please try again.';
        return null;
      }
      
      currentClientSecret = data.clientSecret;
      return data.clientSecret;
    } catch (error) {
      console.error('Error creating payment intent:', error);
      document.getElementById('card-errors').textContent = 'An error occurred. Please refresh the page and try again.';
      return null;
    }
  }
  
  // Initialize payment amount display
  updatePaymentAmount();
  
  async function initializePayment() {
    try {
      // Check if Stripe is properly initialized
      if (!stripe || !stripe._apiKey) {
        document.getElementById('card-errors').textContent = 'Payment system is not properly configured. Please contact support.';
        return;
      }
      
      // Get selected payment type
      const selectedPaymentType = document.querySelector('input[name="payment_type"]:checked').value;
      currentPaymentType = selectedPaymentType;
      
      // Create payment intent
      const clientSecret = await createPaymentIntent(selectedPaymentType);
      if (!clientSecret) {
        return;
      }
      
      // Initialize Stripe Elements
      elements = stripe.elements({ clientSecret: clientSecret });
      cardElement = elements.create('card', {
        style: {
          base: {
            fontSize: '16px',
            color: '#32325d',
            '::placeholder': {
              color: '#aab7c4',
            },
          },
          invalid: {
            color: '#fa755a',
            iconColor: '#fa755a',
          },
        },
      });
      
      cardElement.mount('#card-element');
      
      // Handle real-time validation errors
      cardElement.on('change', function(event) {
        const displayError = document.getElementById('card-errors');
        if (event.error) {
          displayError.textContent = event.error.message;
        } else {
          displayError.textContent = '';
        }
      });
      
      // Handle form submission
      const form = document.getElementById('payment-form');
      form.addEventListener('submit', async function(event) {
        event.preventDefault();
        
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('button-text');
        const spinner = document.getElementById('spinner');
        
        // Get current payment type
        const selectedPaymentType = document.querySelector('input[name="payment_type"]:checked').value;
        
        // If payment type changed, recreate payment intent
        if (selectedPaymentType !== currentPaymentType || !currentClientSecret) {
          const newClientSecret = await createPaymentIntent(selectedPaymentType);
          if (!newClientSecret) {
            submitButton.disabled = false;
            buttonText.style.display = 'inline';
            spinner.style.display = 'none';
            return;
          }
          currentClientSecret = newClientSecret;
          currentPaymentType = selectedPaymentType;
        }
        
        // Disable button and show spinner
        submitButton.disabled = true;
        buttonText.style.display = 'none';
        spinner.style.display = 'inline';
        
        // Confirm payment with Stripe
        const { error, paymentIntent } = await stripe.confirmCardPayment(currentClientSecret, {
          payment_method: {
            card: cardElement,
            billing_details: {
              email: '<%= @attendee_registration.guardian_1_email %>',
              name: '<%= @attendee_registration.guardian_1_name %>',
            },
          },
        });
        
        if (error) {
          // Show error to customer
          document.getElementById('card-errors').textContent = error.message;
          submitButton.disabled = false;
          buttonText.style.display = 'inline';
          spinner.style.display = 'none';
        } else {
          // Payment succeeded
          if (paymentIntent.status === 'succeeded') {
            // Redirect to success page
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/attendee_registrations/${registrationId}/payment_success`;
            
            const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'authenticity_token';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);
            
            const paymentIntentInput = document.createElement('input');
            paymentIntentInput.type = 'hidden';
            paymentIntentInput.name = 'payment_intent_id';
            paymentIntentInput.value = paymentIntent.id;
            form.appendChild(paymentIntentInput);
            
            const paymentTypeInput = document.createElement('input');
            paymentTypeInput.type = 'hidden';
            paymentTypeInput.name = 'payment_type';
            paymentTypeInput.value = selectedPaymentType;
            form.appendChild(paymentTypeInput);
            
            document.body.appendChild(form);
            form.submit();
          }
        }
      });
    } catch (error) {
      console.error('Error initializing payment:', error);
      document.getElementById('card-errors').textContent = 'An error occurred. Please refresh the page and try again.';
    }
  }
  
  // Initialize when page loads
  document.addEventListener('DOMContentLoaded', initializePayment);
</script>

<style>
  #card-element {
    padding: 12px;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    background-color: white;
  }
  
  #card-element:focus {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
  }
  
  .payment-option {
    transition: all 0.2s ease;
  }
  
  .payment-option input[type="radio"]:checked + div {
    color: #1e40af;
  }
  
  .payment-option input[type="radio"]:checked ~ div {
    color: #1e40af;
  }
  
  input[type="radio"]:checked ~ .payment-option-content {
    color: #1e40af;
  }
  
  /* Highlight selected payment option */
  .payment-option input[type="radio"]:checked {
    border-color: #3b82f6;
  }
  
  label.payment-option:has(input[type="radio"]:checked),
  .payment-option input[type="radio"]:checked {
    border-color: #3b82f6;
  }
  
  /* Fallback for browsers without :has() support */
  .payment-option.selected {
    border-color: #3b82f6;
    background-color: #eff6ff;
  }
</style>

