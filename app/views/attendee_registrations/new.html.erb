<div class="content-section">
  <div class="section-header">
    <h2 class="section-title">Attendee Registration</h2>
  </div>
  
  <div class="section-content">
    <div class="form-container">
      <%= form_with(model: @attendee_registration, url: attendee_registrations_path, data: {turbo: false}) do |f| %>
        <% if @attendee_registration.errors.any? %>
          <div class="bg-red-50 border border-red-200 text-red-800 rounded-lg p-4 mb-4">
            <h3 class="font-semibold mb-2"><%= pluralize(@attendee_registration.errors.count, "error") %> prohibited this registration from being saved:</h3>
            <ul class="list-disc list-inside">
              <% @attendee_registration.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <!-- Guardian 1 Information -->
        <div style="border-bottom: 1px solid #e5e7eb; padding-bottom: 12px; margin-bottom: 16px;">
          <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 12px; color: #1f2937;">Primary Guardian Information</h3>
          
          <div class="form-grid form-grid-3">
            <div class="form-group">
              <%= f.label :guardian_1_name, "Full Name", class: "form-label" %>
              <%= f.text_field :guardian_1_name, class: "form-control", required: true %>
            </div>

            <div class="form-group">
              <%= f.label :guardian_1_email, "Email", class: "form-label" %>
              <%= f.email_field :guardian_1_email, class: "form-control", required: true %>
            </div>

            <div class="form-group">
              <%= f.label :guardian_1_phone, "Phone", class: "form-label" %>
              <%= f.telephone_field :guardian_1_phone, class: "form-control", required: true %>
            </div>
          </div>

          <div style="margin-top: 12px;">
            <h4 style="font-weight: 600; margin-bottom: 8px; font-size: 14px;">Address</h4>
            <div class="form-grid form-grid-2">
              <div class="form-group">
                <%= f.label :guardian_1_address_line_1, "Address Line 1", class: "form-label" %>
                <%= f.text_field :guardian_1_address_line_1, class: "form-control", required: true %>
              </div>

              <div class="form-group">
                <%= f.label :guardian_1_address_line_2, "Address Line 2 (Optional)", class: "form-label" %>
                <%= f.text_field :guardian_1_address_line_2, class: "form-control" %>
              </div>
            </div>

            <div class="form-grid form-grid-3" style="margin-top: 12px;">
              <div class="form-group">
                <%= f.label :guardian_1_city, "City", class: "form-label" %>
                <%= f.text_field :guardian_1_city, class: "form-control", required: true %>
              </div>

              <div class="form-group">
                <%= f.label :guardian_1_state, "State", class: "form-label" %>
                <%= f.text_field :guardian_1_state, class: "form-control", required: true, maxlength: 2, placeholder: "CA" %>
              </div>

              <div class="form-group">
                <%= f.label :guardian_1_zip, "ZIP Code", class: "form-label" %>
                <%= f.text_field :guardian_1_zip, class: "form-control", required: true %>
              </div>
            </div>
          </div>
        </div>

        <!-- Guardian 2 Information (Optional) -->
        <div style="border-bottom: 1px solid #e5e7eb; padding-bottom: 12px; margin-bottom: 16px;">
          <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 12px; color: #1f2937;">Second Guardian Information (Optional)</h3>
          
          <div class="form-grid form-grid-3">
            <div class="form-group">
              <%= f.label :guardian_2_name, "Full Name", class: "form-label" %>
              <%= f.text_field :guardian_2_name, class: "form-control" %>
            </div>

            <div class="form-group">
              <%= f.label :guardian_2_email, "Email", class: "form-label" %>
              <%= f.email_field :guardian_2_email, class: "form-control" %>
            </div>

            <div class="form-group">
              <%= f.label :guardian_2_phone, "Phone", class: "form-label" %>
              <%= f.telephone_field :guardian_2_phone, class: "form-control" %>
            </div>
          </div>

          <div class="form-group" style="margin-top: 12px;">
            <label style="display: flex; align-items: center;">
              <%= f.check_box :guardian_2_same_address, style: "margin-right: 8px;" %>
              <span style="font-size: 14px;">Same address as primary guardian</span>
            </label>
          </div>

          <div id="guardian-2-address" style="margin-top: 12px; display: none;">
            <h4 style="font-weight: 600; margin-bottom: 8px; font-size: 14px;">Address</h4>
            <div class="form-grid form-grid-2">
              <div class="form-group">
                <%= f.label :guardian_2_address_line_1, "Address Line 1", class: "form-label" %>
                <%= f.text_field :guardian_2_address_line_1, class: "form-control" %>
              </div>

              <div class="form-group">
                <%= f.label :guardian_2_address_line_2, "Address Line 2 (Optional)", class: "form-label" %>
                <%= f.text_field :guardian_2_address_line_2, class: "form-control" %>
              </div>
            </div>

            <div class="form-grid form-grid-3" style="margin-top: 12px;">
              <div class="form-group">
                <%= f.label :guardian_2_city, "City", class: "form-label" %>
                <%= f.text_field :guardian_2_city, class: "form-control" %>
              </div>

              <div class="form-group">
                <%= f.label :guardian_2_state, "State", class: "form-label" %>
                <%= f.text_field :guardian_2_state, class: "form-control", maxlength: 2, placeholder: "CA" %>
              </div>

              <div class="form-group">
                <%= f.label :guardian_2_zip, "ZIP Code", class: "form-label" %>
                <%= f.text_field :guardian_2_zip, class: "form-control" %>
              </div>
            </div>
          </div>
        </div>

        <!-- Emergency Contacts -->
        <div style="border-bottom: 1px solid #e5e7eb; padding-bottom: 12px; margin-bottom: 16px;">
          <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #1f2937;">Emergency Contacts</h3>
          <p style="font-size: 12px; color: #6b7280; margin-bottom: 12px;">Please provide at least one emergency contact (someone other than the guardians listed above).</p>
          
          <div style="margin-bottom: 12px;">
            <h4 style="font-weight: 600; margin-bottom: 8px; font-size: 14px; color: #374151;">Emergency Contact 1 (Required)</h4>
            <div class="form-grid form-grid-2">
              <div class="form-group">
                <%= f.label :emergency_contact_1_name, "Full Name", class: "form-label" %>
                <%= f.text_field :emergency_contact_1_name, class: "form-control", required: true %>
              </div>

              <div class="form-group">
                <%= f.label :emergency_contact_1_phone, "Phone Number", class: "form-label" %>
                <%= f.telephone_field :emergency_contact_1_phone, class: "form-control", required: true %>
              </div>
            </div>
          </div>

          <div>
            <h4 style="font-weight: 600; margin-bottom: 8px; font-size: 14px; color: #374151;">Emergency Contact 2 (Optional)</h4>
            <div class="form-grid form-grid-2">
              <div class="form-group">
                <%= f.label :emergency_contact_2_name, "Full Name", class: "form-label" %>
                <%= f.text_field :emergency_contact_2_name, class: "form-control" %>
              </div>

              <div class="form-group">
                <%= f.label :emergency_contact_2_phone, "Phone Number", class: "form-label" %>
                <%= f.telephone_field :emergency_contact_2_phone, class: "form-control" %>
              </div>
            </div>
          </div>
        </div>

        <!-- Attendees (Children) Section -->
        <div style="border-bottom: 1px solid #e5e7eb; padding-bottom: 12px; margin-bottom: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h3 style="font-size: 18px; font-weight: 600; color: #1f2937;">Attending Children/Youth</h3>
            <button type="button" id="add-attendee-btn" class="btn btn-outline" style="font-size: 14px; padding: 4px 12px;">+ Add Another Child</button>
          </div>

          <div id="attendees-container">
            <%= f.fields_for :attendees do |attendee_fields| %>
              <%= render 'attendee_fields', f: attendee_fields %>
            <% end %>
          </div>
        </div>

        <!-- Interest in Counselling -->
        <div style="border-bottom: 1px solid #e5e7eb; padding-bottom: 12px; margin-bottom: 16px;">
          <div class="form-group">
            <label style="display: flex; align-items: center;">
              <%= f.check_box :interest_in_counselling, style: "margin-right: 8px;" %>
              <span style="font-size: 14px;">I'm interested in serving as a counsellor (you'll receive more information)</span>
            </label>
          </div>
        </div>

        <!-- Additional Notes -->
        <div style="border-bottom: 1px solid #e5e7eb; padding-bottom: 12px; margin-bottom: 16px;">
          <div class="form-group">
            <%= f.label :notes, "Additional Notes or Questions", class: "form-label" %>
            <%= f.text_area :notes, rows: 3, class: "form-control", placeholder: "Any additional information you'd like us to know..." %>
          </div>
        </div>

        <!-- Medical Consent -->
        <div style="border-bottom: 1px solid #e5e7eb; padding-bottom: 12px; margin-bottom: 16px;">
          <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #1f2937;">Medical Consent</h3>
          <div class="form-group">
            <label style="display: flex; align-items: start;">
              <%= f.check_box :medical_consent, style: "margin-right: 8px; margin-top: 4px;", required: true %>
              <span style="font-size: 14px;">I authorize camp staff to seek and approve emergency medical treatment for any attendee in this registration if required. I understand that every effort will be made to contact the guardians and emergency contacts listed above, but in the event of an emergency where guardians cannot be reached, I give permission for necessary medical care.</span>
            </label>
          </div>
        </div>

        <!-- Terms Agreement -->
        <div style="border-bottom: 1px solid #e5e7eb; padding-bottom: 12px; margin-bottom: 16px;">
          <div class="form-group">
            <label style="display: flex; align-items: start;">
              <%= f.check_box :terms_agreement, style: "margin-right: 8px; margin-top: 4px;", required: true %>
              <span style="font-size: 14px;">I agree to the terms and conditions and understand that all information provided is accurate to the best of my knowledge.</span>
            </label>
          </div>
        </div>
        
        <div class="form-actions">
          <%= f.submit "Submit Registration", class: "btn btn-primary w-full" %>
        </div>
      <% end %>
      
      <div class="auth-links mt-6 text-center">
        <div class="space-y-2">
          <%= link_to "Register as Counsellor", new_counsellor_path, class: "btn btn-outline w-full" %>
          <%= link_to "Back to Home", root_path, class: "text-blue-600 hover:text-blue-800 block mt-2" %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Store handlers for cleanup
  let handlers = {
    guardian2Change: null,
    addButtonClick: null,
    removeButtonClick: null
  };

  // Initialize form functionality
  const initializeAttendeeForm = () => {
    // Reset attendee index based on current form state
    const container = document.getElementById('attendees-container');
    const existingAttendees = container ? container.querySelectorAll('.attendee-form-group').length : 0;
    let attendeeIndex = existingAttendees || <%= @attendee_registration.attendees.size %>;

    // Toggle Guardian 2 address fields
    const sameAddressCheckbox = document.querySelector('#attendee_registration_guardian_2_same_address');
    const guardian2Address = document.getElementById('guardian-2-address');
    
    // Cleanup previous handler
    if (handlers.guardian2Change && sameAddressCheckbox) {
      sameAddressCheckbox.removeEventListener('change', handlers.guardian2Change);
    }
    
    if (sameAddressCheckbox && guardian2Address) {
      handlers.guardian2Change = function() {
        guardian2Address.style.display = this.checked ? 'none' : 'block';
      };
      sameAddressCheckbox.addEventListener('change', handlers.guardian2Change);
      
      // Set initial state
      guardian2Address.style.display = sameAddressCheckbox.checked ? 'none' : 'block';
    }

    // Dynamic attendee form management
    const addButton = document.getElementById('add-attendee-btn');
    const attendeesContainer = document.getElementById('attendees-container');
    
    if (!addButton || !attendeesContainer) return;
    
    // Cleanup previous handlers
    if (handlers.addButtonClick) {
      addButton.removeEventListener('click', handlers.addButtonClick);
    }
    if (handlers.removeButtonClick) {
      attendeesContainer.removeEventListener('click', handlers.removeButtonClick);
    }
    
    handlers.addButtonClick = function(e) {
      e.preventDefault();
      const newId = new Date().getTime();
      const template = `
        <div class="attendee-form-group" style="border: 1px solid #d1d5db; border-radius: 8px; padding: 12px; margin-bottom: 12px; background-color: #f9fafb;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h4 style="font-size: 16px; font-weight: 600; color: #374151;">Child ${attendeeIndex + 1}</h4>
            <button type="button" class="remove-attendee-btn" style="color: #dc2626; font-size: 14px; background: none; border: none; cursor: pointer;">Remove</button>
          </div>

          <div class="form-grid form-grid-2">
            <div class="form-group">
              <label class="form-label">First Name</label>
              <input type="text" name="attendee_registration[attendees_attributes][${newId}][first_name]" class="form-control" required />
            </div>

            <div class="form-group">
              <label class="form-label">Last Name</label>
              <input type="text" name="attendee_registration[attendees_attributes][${newId}][last_name]" class="form-control" required />
            </div>

            <div class="form-group">
              <label class="form-label">Date of Birth</label>
              <input type="date" name="attendee_registration[attendees_attributes][${newId}][date_of_birth]" class="form-control" required />
            </div>

            <div class="form-group">
              <label class="form-label">Gender</label>
              <select name="attendee_registration[attendees_attributes][${newId}][gender]" class="form-control">
                <option value="">Select...</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">T-Shirt Size</label>
              <select name="attendee_registration[attendees_attributes][${newId}][tshirt_size]" class="form-control">
                <option value="">Select...</option>
                <option value="Youth S">Youth S</option>
                <option value="Youth M">Youth M</option>
                <option value="Youth L">Youth L</option>
                <option value="Youth XL">Youth XL</option>
                <option value="Adult S">Adult S</option>
                <option value="Adult M">Adult M</option>
                <option value="Adult L">Adult L</option>
                <option value="Adult XL">Adult XL</option>
                <option value="Adult XXL">Adult XXL</option>
              </select>
            </div>

            <div class="form-group">
              <label style="display: flex; align-items: center;">
                <input type="checkbox" name="attendee_registration[attendees_attributes][${newId}][piano]" value="1" style="margin-right: 8px;" />
                <span style="font-size: 14px;">This attendee plays piano</span>
              </label>
            </div>

            <div class="form-group" style="grid-column: 1 / -1;">
              <div class="form-grid form-grid-3">
                <div class="form-group">
                  <label class="form-label">Phone Number</label>
                  <input type="tel" name="attendee_registration[attendees_attributes][${newId}][phone]" class="form-control" />
                </div>

                <div class="form-group">
                  <label class="form-label">Email</label>
                  <input type="email" name="attendee_registration[attendees_attributes][${newId}][email]" class="form-control" />
                </div>

                <div class="form-group">
                  <label class="form-label">Ecclesia</label>
                  <input type="text" name="attendee_registration[attendees_attributes][${newId}][ecclesia]" class="form-control" />
                </div>
              </div>
            </div>

            <div class="form-group" style="grid-column: 1 / -1;">
              <h5 style="font-weight: 600; margin-bottom: 8px; font-size: 14px;">Address</h5>
            </div>

            <div class="form-group" style="grid-column: 1 / -1;">
              <label class="form-label">Address Line 1</label>
              <input type="text" name="attendee_registration[attendees_attributes][${newId}][address_line_1]" class="form-control" />
            </div>

            <div class="form-group" style="grid-column: 1 / -1;">
              <label class="form-label">Address Line 2 (Optional)</label>
              <input type="text" name="attendee_registration[attendees_attributes][${newId}][address_line_2]" class="form-control" />
            </div>

            <div class="form-group">
              <label class="form-label">City</label>
              <input type="text" name="attendee_registration[attendees_attributes][${newId}][city]" class="form-control" />
            </div>

            <div class="form-group">
              <label class="form-label">State</label>
              <input type="text" name="attendee_registration[attendees_attributes][${newId}][state]" class="form-control" maxlength="2" placeholder="CA" />
            </div>

            <div class="form-group">
              <label class="form-label">ZIP Code</label>
              <input type="text" name="attendee_registration[attendees_attributes][${newId}][zip]" class="form-control" />
            </div>

            <div class="form-group" style="grid-column: 1 / -1;">
              <label class="form-label">Medical Conditions</label>
              <textarea name="attendee_registration[attendees_attributes][${newId}][medical_conditions]" rows="2" class="form-control" placeholder="Any medical conditions we should be aware of..."></textarea>
            </div>

            <div class="form-group" style="grid-column: 1 / -1;">
              <label class="form-label">Dietary Restrictions</label>
              <textarea name="attendee_registration[attendees_attributes][${newId}][dietary_restrictions]" rows="2" class="form-control" placeholder="Any dietary restrictions..."></textarea>
            </div>

            <div class="form-group" style="grid-column: 1 / -1;">
              <label class="form-label">Allergies</label>
              <textarea name="attendee_registration[attendees_attributes][${newId}][allergies]" rows="2" class="form-control" placeholder="Any allergies..."></textarea>
            </div>

            <div class="form-group" style="grid-column: 1 / -1;">
              <label class="form-label">Special Needs</label>
              <textarea name="attendee_registration[attendees_attributes][${newId}][special_needs]" rows="2" class="form-control" placeholder="Any special needs or accommodations required..."></textarea>
            </div>

            <div class="form-group" style="grid-column: 1 / -1;">
              <label class="form-label">Additional Notes</label>
              <textarea name="attendee_registration[attendees_attributes][${newId}][notes]" rows="2" class="form-control" placeholder="Any additional information about this child..."></textarea>
            </div>
          </div>
        </div>
      `;
      
      attendeesContainer.insertAdjacentHTML('beforeend', template);
      attendeeIndex++;
      
      // Update child numbers
      updateChildNumbers();
    };
    
    addButton.addEventListener('click', handlers.addButtonClick);
    
    // Remove attendee handler (event delegation)
    handlers.removeButtonClick = function(e) {
      if (e.target.classList.contains('remove-attendee-btn')) {
        e.preventDefault();
        const attendeeCount = attendeesContainer.querySelectorAll('.attendee-form-group').length;
        
        if (attendeeCount > 1) {
          e.target.closest('.attendee-form-group').remove();
          updateChildNumbers();
        } else {
          alert('You must register at least one child.');
        }
      }
    };
    
    attendeesContainer.addEventListener('click', handlers.removeButtonClick);
    
    function updateChildNumbers() {
      const attendeeForms = attendeesContainer.querySelectorAll('.attendee-form-group');
      attendeeForms.forEach((form, index) => {
        const header = form.querySelector('h4');
        if (header) {
          header.textContent = `Child ${index + 1}`;
        }
      });
    }
  };

  // Initialize on DOMContentLoaded (for initial page load)
  document.addEventListener('DOMContentLoaded', initializeAttendeeForm);

  // Initialize on Turbo load (for Turbo navigation)
  document.addEventListener('turbo:load', initializeAttendeeForm);

  // Also initialize on turbo:render for compatibility
  document.addEventListener('turbo:render', initializeAttendeeForm);
</script>


