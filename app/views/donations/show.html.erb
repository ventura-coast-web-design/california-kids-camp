<div class="content-section">
  <div class="section-header">
    <h2 class="section-title">Donate to California Kids Camp</h2>
  </div>
  
  <div class="section-content">
    <div class="form-container">
      <p class="mb-6" style="margin-bottom: 24px; color: #374151; line-height: 1.6;">
        Thank you for your interest in supporting California Kids Camp! Your generous donation helps us provide an amazing camp experience for children. The minimum donation amount is $5.00.
      </p>

      <!-- Donation Form -->
      <div class="border-b border-gray-200 pb-6" style="border-bottom: 1px solid #e5e7eb; padding-bottom: 24px;">
        <h3 class="text-xl font-semibold mb-4 text-gray-800" style="font-size: 20px; font-weight: 600; margin-bottom: 16px; color: #1f2937;">Donation Information</h3>
        
        <form id="donation-form">
          <!-- Donor Information -->
          <div class="mb-4" style="margin-bottom: 16px;">
            <label for="donor-name" class="block text-sm font-medium text-gray-700 mb-2" style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">
              Name <span class="text-red-600" style="color: #dc2626;">*</span>
            </label>
            <input type="text" id="donor-name" name="name" required 
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                   style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px;"
                   placeholder="Your name">
          </div>

          <div class="mb-4" style="margin-bottom: 16px;">
            <label for="donor-email" class="block text-sm font-medium text-gray-700 mb-2" style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">
              Email <span class="text-red-600" style="color: #dc2626;">*</span>
            </label>
            <input type="email" id="donor-email" name="email" required 
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                   style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px;"
                   placeholder="your.email@example.com">
          </div>

          <div class="mb-4" style="margin-bottom: 16px;">
            <label for="donation-amount" class="block text-sm font-medium text-gray-700 mb-2" style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">
              Donation Amount <span class="text-red-600" style="color: #dc2626;">*</span>
              <span class="text-sm text-gray-500" style="font-size: 14px; color: #6b7280;">(Minimum $5.00)</span>
            </label>
            <div class="flex items-center" style="display: flex; align-items: center;">
              <span class="text-lg font-semibold mr-2" style="font-size: 18px; font-weight: 600; margin-right: 8px;">$</span>
              <input type="number" id="donation-amount" name="amount" required min="5" step="0.01" 
                     class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                     style="flex: 1; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px;"
                     placeholder="5.00" value="25.00">
            </div>
          </div>

          <!-- Payment Information -->
          <div class="mt-6" style="margin-top: 24px;">
            <h3 class="text-xl font-semibold mb-4 text-gray-800" style="font-size: 20px; font-weight: 600; margin-bottom: 16px; color: #1f2937;">Payment Information</h3>
            
            <div id="card-element" class="mb-4" style="margin-bottom: 16px;">
              <!-- Stripe Elements will create form elements here -->
            </div>
            
            <!-- Display form errors -->
            <div id="card-errors" role="alert" class="text-red-600 mb-4" style="color: #dc2626; margin-bottom: 16px;"></div>
            
            <div class="form-actions">
              <button type="submit" id="submit-button" class="btn btn-primary w-full" style="width: 100%;">
                <span id="button-text">Donate $<span id="payment-amount">25.00</span></span>
                <span id="spinner" style="display: none;">Processing...</span>
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // Get donation form elements
  const donationForm = document.getElementById('donation-form');
  const amountInput = document.getElementById('donation-amount');
  const paymentAmountSpan = document.getElementById('payment-amount');
  const nameInput = document.getElementById('donor-name');
  const emailInput = document.getElementById('donor-email');
  
  // Update payment amount display when amount changes
  amountInput.addEventListener('input', function() {
    const amount = parseFloat(this.value) || 0;
    if (amount >= 5) {
      paymentAmountSpan.textContent = amount.toFixed(2);
    } else {
      paymentAmountSpan.textContent = '5.00';
    }
  });
  
  // Create payment intent and set up Stripe Elements
  // Use window scope to avoid redeclaration issues with Turbo
  if (!window.donationElements) {
    window.donationElements = {};
  }
  let elements = window.donationElements.elements;
  let cardElement = window.donationElements.cardElement;
  let currentClientSecret = window.donationElements.currentClientSecret || null;
  let currentDonationId = window.donationElements.donationId || null;
  
  // Load Stripe.js only if not already loaded
  function loadStripeScript() {
    return new Promise((resolve, reject) => {
      if (typeof Stripe !== 'undefined') {
        resolve();
        return;
      }
      
      // Check if script is already being loaded
      const existingScript = document.querySelector('script[src="https://js.stripe.com/v3/"]');
      if (existingScript) {
        // Wait for it to load with a timeout
        let attempts = 0;
        const maxAttempts = 50; // 5 seconds max wait
        const checkInterval = setInterval(() => {
          attempts++;
          if (typeof Stripe !== 'undefined') {
            clearInterval(checkInterval);
            resolve();
          } else if (attempts >= maxAttempts) {
            clearInterval(checkInterval);
            reject(new Error('Stripe script loading timeout'));
          }
        }, 100);
        return;
      }
      
      const script = document.createElement('script');
      script.src = 'https://js.stripe.com/v3/';
      script.async = true;
      script.onload = () => {
        // Double check Stripe is available
        if (typeof Stripe !== 'undefined') {
          resolve();
        } else {
          reject(new Error('Stripe script loaded but Stripe object not available'));
        }
      };
      script.onerror = () => {
        reject(new Error('Failed to load Stripe script'));
      };
      document.head.appendChild(script);
    });
  }
  
  // Initialize Stripe instance
  function getStripeInstance() {
    // Use window.stripeInstance to avoid redeclaration issues with Turbo
    if (!window.stripeInstance || window.stripePublishableKey !== '<%= @stripe_publishable_key %>') {
      window.stripeInstance = Stripe('<%= @stripe_publishable_key %>');
      window.stripePublishableKey = '<%= @stripe_publishable_key %>';
    }
    return window.stripeInstance;
  }
  
  // Create payment intent
  async function createPaymentIntent() {
    const amount = parseFloat(amountInput.value) || 0;
    const name = nameInput.value.trim();
    const email = emailInput.value.trim();
    
    // Validate amount
    if (amount < 5) {
      document.getElementById('card-errors').textContent = 'Minimum donation amount is $5.00';
      return null;
    }
    
    // Validate required fields
    if (!name || !email) {
      document.getElementById('card-errors').textContent = 'Please fill in all required fields';
      return null;
    }
    
    try {
      const response = await fetch('/donations/create_payment_intent', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({
          amount: amount,
          name: name,
          email: email
        })
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to create payment intent');
      }
      
      const data = await response.json();
      
      if (data.error) {
        document.getElementById('card-errors').textContent = data.error;
        return null;
      }
      
      if (!data.clientSecret) {
        document.getElementById('card-errors').textContent = 'Failed to initialize payment. Please try again.';
        return null;
      }
      
      currentClientSecret = data.clientSecret;
      currentDonationId = data.donation_id;
      return data.clientSecret;
    } catch (error) {
      console.error('Error creating payment intent:', error);
      document.getElementById('card-errors').textContent = error.message || 'An error occurred. Please refresh the page and try again.';
      return null;
    }
  }
  
  async function initializePayment() {
    // Prevent multiple initializations
    if (window.donationElements && window.donationElements.isInitialized) {
      return;
    }
    
    try {
      // Wait for DOM to be ready
      const cardElementContainer = document.getElementById('card-element');
      if (!cardElementContainer) {
        // Retry after a short delay
        setTimeout(initializePayment, 100);
        return;
      }
      
      // Load Stripe script if needed
      await loadStripeScript();
      
      // Get Stripe instance
      const stripe = getStripeInstance();
      
      // Check if Stripe is properly initialized
      if (!stripe || !stripe._apiKey) {
        document.getElementById('card-errors').textContent = 'Payment system is not properly configured. Please contact support.';
        return;
      }
      
      // Don't create payment intent yet - wait for form submission
      // Just initialize the card element with a placeholder
      elements = stripe.elements();
      cardElement = elements.create('card', {
        style: {
          base: {
            fontSize: '16px',
            color: '#32325d',
            '::placeholder': {
              color: '#aab7c4',
            },
          },
          invalid: {
            color: '#fa755a',
            iconColor: '#fa755a',
          },
        },
      });
      
      // Store in window scope
      window.donationElements.elements = elements;
      window.donationElements.cardElement = cardElement;
      
      // Mount the card element
      try {
        cardElement.mount('#card-element');
        window.donationElements.isInitialized = true;
      } catch (error) {
        console.error('Error mounting card element:', error);
        document.getElementById('card-errors').textContent = 'Failed to initialize payment form. Please refresh the page.';
        return;
      }
      
      // Handle real-time validation errors
      cardElement.on('change', function(event) {
        const displayError = document.getElementById('card-errors');
        if (event.error) {
          displayError.textContent = event.error.message;
        } else {
          displayError.textContent = '';
        }
      });
      
      // Handle form submission - use window scope to persist across page reloads
      if (!window.donationProcessing) {
        window.donationProcessing = false;
      }
      
      // Define handler function separately so we can reference it
      async function handleDonationSubmit(event) {
        event.preventDefault();
        
        // Prevent duplicate submissions
        if (window.donationProcessing) {
          console.log('Payment already processing, ignoring duplicate submission');
          return;
        }
        
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('button-text');
        const spinner = document.getElementById('spinner');
        
        // Validate form
        const amount = parseFloat(amountInput.value) || 0;
        const name = nameInput.value.trim();
        const email = emailInput.value.trim();
        
        if (amount < 5) {
          document.getElementById('card-errors').textContent = 'Minimum donation amount is $5.00';
          return;
        }
        
        if (!name || !email) {
          document.getElementById('card-errors').textContent = 'Please fill in all required fields';
          return;
        }
        
        // Set processing flag and disable button
        window.donationProcessing = true;
        submitButton.disabled = true;
        buttonText.style.display = 'none';
        spinner.style.display = 'inline';
        
        try {
          // Create payment intent
          const clientSecret = await createPaymentIntent();
          if (!clientSecret) {
            submitButton.disabled = false;
            buttonText.style.display = 'inline';
            spinner.style.display = 'none';
            window.donationProcessing = false;
            return;
          }
          
          // Store the client secret and donation ID
          window.donationElements.currentClientSecret = clientSecret;
          window.donationElements.donationId = currentDonationId;
          
          // Verify the card element exists and is mounted
          const cardElementContainer = document.getElementById('card-element');
          if (!cardElement || !cardElementContainer) {
            document.getElementById('card-errors').textContent = 'Payment form is not ready. Please refresh the page and try again.';
            submitButton.disabled = false;
            buttonText.style.display = 'inline';
            spinner.style.display = 'none';
            window.donationProcessing = false;
            return;
          }
          
          // Create payment method from the card element
          const { error: pmError, paymentMethod } = await stripe.createPaymentMethod({
            type: 'card',
            card: cardElement,
            billing_details: {
              email: email,
              name: name,
            },
          });
          
          if (pmError) {
            // Show error to customer
            document.getElementById('card-errors').textContent = pmError.message;
            submitButton.disabled = false;
            buttonText.style.display = 'inline';
            spinner.style.display = 'none';
            window.donationProcessing = false;
            return;
          }
          
          // Confirm payment with the payment method
          const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
            payment_method: paymentMethod.id,
          });
          
          if (error) {
            // Show error to customer
            document.getElementById('card-errors').textContent = error.message;
            submitButton.disabled = false;
            buttonText.style.display = 'inline';
            spinner.style.display = 'none';
            window.donationProcessing = false;
          } else {
            // Payment succeeded
            if (paymentIntent.status === 'succeeded') {
              // Prevent multiple redirects - check if we've already submitted
              if (window.donationRedirected) {
                console.log('Redirect already initiated, ignoring duplicate');
                return;
              }
              window.donationRedirected = true;
              
              // Redirect to success page - use window.location to prevent duplicate form submissions
              window.location.href = `/donations/${currentDonationId}/payment_success?payment_intent_id=${encodeURIComponent(paymentIntent.id)}`;
            } else {
              // Payment not succeeded, re-enable form
              submitButton.disabled = false;
              buttonText.style.display = 'inline';
              spinner.style.display = 'none';
              window.donationProcessing = false;
            }
          }
        } catch (err) {
          // Handle any unexpected errors
          console.error('Payment error:', err);
          
          // Check if payment actually succeeded despite the error
          // If we have a payment intent ID, check its status
          if (currentDonationId && window.donationElements.currentClientSecret) {
            try {
              const paymentIntent = await stripe.retrievePaymentIntent(window.donationElements.currentClientSecret);
              if (paymentIntent.paymentIntent && paymentIntent.paymentIntent.status === 'succeeded') {
                // Payment succeeded, redirect to success page
                if (!window.donationRedirected) {
                  window.donationRedirected = true;
                  window.location.href = `/donations/${currentDonationId}/payment_success?payment_intent_id=${encodeURIComponent(paymentIntent.paymentIntent.id)}`;
                  return;
                }
              }
            } catch (checkError) {
              console.error('Error checking payment status:', checkError);
            }
          }
          
          document.getElementById('card-errors').textContent = 'An unexpected error occurred. If your payment was processed, you will receive a confirmation email.';
          submitButton.disabled = false;
          buttonText.style.display = 'inline';
          spinner.style.display = 'none';
          window.donationProcessing = false;
        }
      }
      
      donationForm.addEventListener('submit', handleDonationSubmit);
    } catch (error) {
      console.error('Error initializing payment:', error);
      document.getElementById('card-errors').textContent = 'An error occurred. Please refresh the page and try again.';
    }
  }
  
  // Initialize when page loads - handle both regular page loads and Turbo navigation
  function startInitialization() {
    // Reset initialization flag when page changes (but keep window scope)
    if (window.donationElements) {
      window.donationElements.isInitialized = false;
    }
    
    // Ensure DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializePayment);
    } else {
      // DOM is already ready, but wait a tick to ensure everything is rendered
      setTimeout(initializePayment, 50);
    }
  }
  
  // Start initialization
  startInitialization();
  
  // Also listen for Turbo events if Turbo is available
  if (typeof Turbo !== 'undefined') {
    document.addEventListener('turbo:load', function() {
      if (window.donationElements) {
        window.donationElements.isInitialized = false;
      }
      setTimeout(initializePayment, 50);
    });
    document.addEventListener('turbo:render', function() {
      if (!window.donationElements || !window.donationElements.isInitialized) {
        setTimeout(initializePayment, 50);
      }
    });
  }
</script>

<style>
  #card-element {
    padding: 12px;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    background-color: white;
  }
  
  #card-element:focus {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
  }
</style>
