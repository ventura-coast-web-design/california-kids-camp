<div class="content-section">
  <div class="section-header">
    <h2 class="section-title">VOLUNTEER NOW! SPACE IS LIMITED!</h2>
    <div class="section-intro">
      <p>Please sign up to volunteer no later than April 15th.</p>
      <p>To be a counselor, you must be a baptized member in good standing and fellowship exclusively based on the BASF. If you would like to volunteer as a counselor, please fill out the form below</p>
      <p><strong>Please note:</strong> Submitting this form does not confirm you as a counselor. We will contact you if we could use your help.</p>
      <p>For more information on what the counseling experience is like, please refer to <%= link_to "our counselor FAQs", counsellor_info_path %>, or reach out to Bro. James and Sis. Kristen Styles.</p>
      <div class="contact-info-box">
        <p>
          <strong>Contact Information:</strong>
        </p>
        <p>
          <a href="tel:805-433-3409">805-433-3409</a><br>
          <a href="mailto:kidscampcalifornia@gmail.com">kidscampcalifornia@gmail.com</a>
        </p>
      </div>
    </div>
  </div>
  
  <div class="section-content">
    <div class="form-container">
      <%= form_with(url: counsellors_path, data: {turbo: false}, id: "counsellor-registration-form") do |f| %>
        <% if flash[:alert] %>
          <div style="background-color: #fef2f2; border: 1px solid #fecaca; color: #991b1b; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
            <p style="margin: 0;"><%= flash[:alert] %></p>
          </div>
        <% end %>

        <div id="counsellors-container">
          <% @counsellors.each_with_index do |counsellor, index| %>
            <%= render 'counsellor_fields', counsellor: counsellor, index: index %>
          <% end %>
        </div>

        <div style="margin-top: 16px; margin-bottom: 24px;">
          <button type="button" id="add-counsellor-btn" class="btn btn-outline" style="width: 100%;">
            + Add Another Counselor
          </button>
        </div>
        
        <div class="form-actions">
          <%= submit_tag "Submit Registration", class: "btn btn-primary w-full" %>
        </div>
      <% end %>
      
      
      <div style="margin-top: 24px; text-align: center;">
        <div>
          <%= link_to "Back to Home", root_path, style: "color: #2563eb; display: block; margin-top: 8px;" %>
        </div>
      </div>
    </div>
  </div>
</div>

<%= render 'counsellor_fields_template' %>

<script>
  (function() {
    'use strict';
  
    document.addEventListener('DOMContentLoaded', function() {
    var counsellorIndex = <%= @counsellors.length %>;
    const addButton = document.getElementById('add-counsellor-btn');
    const counsellorsContainer = document.getElementById('counsellors-container');
    const template = document.getElementById('counsellor-fields-template');
    
    if (addButton && counsellorsContainer && template) {
      addButton.addEventListener('click', function() {
        // Get template HTML - try content first, then innerHTML as fallback
        let templateHTML = '';
        if (template.content) {
          const tempDiv = document.createElement('div');
          tempDiv.appendChild(template.content.cloneNode(true));
          templateHTML = tempDiv.innerHTML;
        } else {
          templateHTML = template.innerHTML;
        }
        
        // Replace all placeholders with the current index
        let updatedHTML = templateHTML.replace(/\{INDEX\}/g, counsellorIndex);
        updatedHTML = updatedHTML.replace(/\{TIMESTAMP\}/g, Date.now());
        
        counsellorsContainer.insertAdjacentHTML('beforeend', updatedHTML);
        counsellorIndex++;
        updateCounsellorNumbers();
        // Setup same address checkboxes for the new form
        setTimeout(function() {
          setupSameAddressCheckboxes();
        }, 50);
      });
      
      // Remove counselor handler (event delegation)
      counsellorsContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-counsellor-btn')) {
          e.preventDefault();
          const counsellorCount = counsellorsContainer.querySelectorAll('.counsellor-form-group').length;
          
          if (counsellorCount > 1) {
            e.target.closest('.counsellor-form-group').remove();
            updateCounsellorNumbers();
          } else {
            alert('You must register at least one counselor.');
          }
        }
      });
      
      // Handle squirts add/remove
      counsellorsContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('add-squirt-btn')) {
          e.preventDefault();
          const counsellorGroup = e.target.closest('.counsellor-form-group');
          const squirtsContainer = counsellorGroup.querySelector('.squirts-container');
          const squirtTemplate = counsellorGroup.querySelector('.squirt-template');
          
          if (squirtsContainer && squirtTemplate) {
            // Find the index of this counselor by looking at the name attribute of the first input
            const firstInput = counsellorGroup.querySelector('input[name*="[first_name]"]');
            let counsellorIndexForSquirt = 0;
            if (firstInput) {
              const nameMatch = firstInput.name.match(/counsellors\[(\d+)\]/);
              if (nameMatch) {
                counsellorIndexForSquirt = parseInt(nameMatch[1]);
              }
            }
            
            // Get template HTML - try content first, then innerHTML as fallback
            let templateHTML = '';
            if (squirtTemplate.content) {
              const tempDiv = document.createElement('div');
              tempDiv.appendChild(squirtTemplate.content.cloneNode(true));
              templateHTML = tempDiv.innerHTML;
            } else {
              templateHTML = squirtTemplate.innerHTML;
            }
            
            // Replace placeholders
            let updatedHTML = templateHTML.replace(/\{INDEX\}/g, counsellorIndexForSquirt);
            updatedHTML = updatedHTML.replace(/\{TIMESTAMP\}/g, Date.now());
            
            squirtsContainer.insertAdjacentHTML('beforeend', updatedHTML);
          }
        }
        
        if (e.target.classList.contains('remove-squirt-btn')) {
          e.preventDefault();
          e.target.closest('.squirt-form-group').remove();
        }
      });
    }
    
    function updateCounsellorNumbers() {
      const counsellorForms = counsellorsContainer.querySelectorAll('.counsellor-form-group');
      counsellorForms.forEach((form, index) => {
        const header = form.querySelector('h3');
        if (header) {
          header.textContent = `Counselor ${index + 1}'s Information:`;
        }
        
        // Update all input/select names to use the correct index
        form.querySelectorAll('input, select').forEach(function(input) {
          const name = input.name;
          if (name && name.includes('counsellors[')) {
            const newName = name.replace(/counsellors\[\d+\]/, `counsellors[${index}]`);
            input.name = newName;
          }
        });
      });
      
      // Update pairing dropdowns
      updatePairingDropdowns();
    }
    
    function updatePairingDropdowns() {
      const counsellorForms = counsellorsContainer.querySelectorAll('.counsellor-form-group');
      
      counsellorForms.forEach((form, currentIndex) => {
        const pairingSelect = form.querySelector('.pairing-select');
        if (!pairingSelect) return;
        
        // Store current selection
        const currentSelection = pairingSelect.value;
        
        // Clear and repopulate options
        pairingSelect.innerHTML = '<option value="">Choose a counselor...</option>';
        
        counsellorForms.forEach((otherForm, otherIndex) => {
          if (currentIndex !== otherIndex) {
            // Get the name from the other form
            const firstNameInput = otherForm.querySelector('input[name*="[first_name]"]');
            const lastNameInput = otherForm.querySelector('input[name*="[last_name]"]');
            let displayName = `Counselor ${otherIndex + 1}`;
            let fullName = '';
            
            if (firstNameInput && lastNameInput) {
              const firstName = firstNameInput.value || '';
              const lastName = lastNameInput.value || '';
              if (firstName || lastName) {
                fullName = `${firstName} ${lastName}`.trim();
                displayName = fullName || displayName;
              }
            }
            
            const option = document.createElement('option');
            option.value = fullName || `Counselor ${otherIndex + 1}`;
            option.textContent = displayName;
            option.dataset.index = otherIndex;
            if (currentSelection === option.value) {
              option.selected = true;
            }
            pairingSelect.appendChild(option);
          }
        });
        
        // Restore selection if it matches
        if (currentSelection) {
          pairingSelect.value = currentSelection;
        }
      });
    }
    
    // Handle pairing select change - clear name input when select is used
    counsellorsContainer.addEventListener('change', function(e) {
      if (e.target.classList.contains('pairing-select')) {
        const form = e.target.closest('.counsellor-form-group');
        const nameInput = form.querySelector('.pairing-name-input');
        
        if (e.target.value) {
          // When a counselor is selected, clear the manual name input
          nameInput.value = '';
        }
      }
    });
    
    // Clear pairing select when name input is filled manually
    counsellorsContainer.addEventListener('input', function(e) {
      if (e.target.classList.contains('pairing-name-input') && e.target.value.trim()) {
        const form = e.target.closest('.counsellor-form-group');
        const pairingSelect = form.querySelector('.pairing-select');
        if (pairingSelect) {
          pairingSelect.value = '';
        }
      }
    });
    
    
    // Update pairing dropdowns when names change
    counsellorsContainer.addEventListener('input', function(e) {
      if (e.target.name && (e.target.name.includes('[first_name]') || e.target.name.includes('[last_name]'))) {
        updatePairingDropdowns();
      }
    });
    
    // Handle "Same address as previous counselor" checkbox
    function setupSameAddressCheckboxes() {
      const checkboxes = document.querySelectorAll('.same-address-checkbox:not([data-listener-attached])');
      checkboxes.forEach(function(checkbox) {
        checkbox.setAttribute('data-listener-attached', 'true');
        
        checkbox.addEventListener('change', function() {
          const currentGroup = this.closest('.counsellor-form-group');
          const addressFields = currentGroup.querySelectorAll('.address-field');
          
          if (this.checked) {
            // Find the previous counselor form
            const allGroups = Array.from(document.querySelectorAll('.counsellor-form-group'));
            const currentGroupIndex = allGroups.indexOf(currentGroup);
            
            if (currentGroupIndex > 0) {
              const previousGroup = allGroups[currentGroupIndex - 1];
              const previousAddressFields = previousGroup.querySelectorAll('.address-field');
              
              // Copy values from previous counselor
              addressFields.forEach(function(field, index) {
                const previousField = previousAddressFields[index];
                if (previousField) {
                  field.value = previousField.value;
                  
                  // Use readonly for text inputs, prevent changes for selects
                  if (field.tagName === 'SELECT') {
                    field.style.backgroundColor = '#f3f4f6';
                    field.style.cursor = 'not-allowed';
                    // Store locked value
                    const lockedValue = previousField.value;
                    field.setAttribute('data-locked-value', lockedValue);
                    // Prevent changes by reverting on change event
                    const preventChange = function(e) {
                      if (field.value !== lockedValue) {
                        field.value = lockedValue;
                      }
                    };
                    field.addEventListener('change', preventChange);
                    field.addEventListener('focus', function() {
                      this.blur();
                    });
                  } else {
                    field.readOnly = true;
                    field.style.backgroundColor = '#f3f4f6';
                    field.style.cursor = 'not-allowed';
                  }
                }
              });
              
              // Listen for changes in previous counselor's address fields
              previousAddressFields.forEach(function(prevField, prevIndex) {
                const updateListener = function() {
                  if (checkbox.checked) {
                    const currentField = addressFields[prevIndex];
                    if (currentField) {
                      currentField.value = prevField.value;
                      if (currentField.tagName === 'SELECT') {
                        currentField.setAttribute('data-locked-value', prevField.value);
                      }
                    }
                  }
                };
                
                // Add listener based on field type
                if (prevField.tagName === 'SELECT') {
                  prevField.addEventListener('change', updateListener);
                } else {
                  prevField.addEventListener('input', updateListener);
                }
              });
            }
          } else {
            // Uncheck: enable fields and clear them
            addressFields.forEach(function(field) {
              if (field.tagName === 'SELECT') {
                // Clone to remove all event listeners
                const newSelect = field.cloneNode(true);
                field.parentNode.replaceChild(newSelect, field);
                newSelect.style.backgroundColor = '';
                newSelect.style.cursor = '';
                newSelect.removeAttribute('data-locked-value');
                const defaultOption = newSelect.querySelector('option[value="United States of America"]');
                if (defaultOption) {
                  newSelect.value = 'United States of America';
                } else {
                  newSelect.value = '';
                }
              } else {
                field.readOnly = false;
                field.style.backgroundColor = '';
                field.style.cursor = '';
                field.value = '';
              }
            });
          }
        });
      });
    }
    
    // Setup checkboxes on page load
    setupSameAddressCheckboxes();
    
    // Re-setup checkboxes when a new counselor is added (handled in the add button click handler)
    
    // Initial update
    updateCounsellorNumbers();
    });
  })();
</script>
